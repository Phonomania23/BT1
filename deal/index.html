<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Сделка — Bloggers.tools</title>

  <!-- Стили -->
  <link rel="stylesheet" href="../css/base.css?v=20250901" />
  <link rel="stylesheet" href="../css/layout.css?v=20250901" />
  <link rel="stylesheet" href="../css/deal.css?v=20250901" />
  <!-- Иконки как в agency.html -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Стили карточек/фильтров: идентичны agency.html -->
  <style>
    .filterbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 16px 0;
      padding: 16px;
      background: var(--surface-2);
      border-radius: 12px;
      border: 1px solid var(--surface-border);
      align-items: flex-start;
    }

    .filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 12px;
      background: var(--surface-2);
      border-radius: 8px;
      border: 1px solid var(--surface-border);
      margin-bottom: 12px;
      width: 100%;
    }
    .filter-group-title {
      width: 100%;
      margin: 0 0 8px 0;
      font-weight: 600;
      color: var(--text);
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-group-title i { color: var(--primary); }

    .chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--surface-2);
      border: 1px solid var(--surface-border);
      border-radius: 20px;
    }
    .chip label {
      font-weight: 600;
      font-size: 14px;
      color: var(--text);
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* инпуты/селекты, кроме чекбокса */
    .chip input[type="text"],
    .chip input[type="number"],
    .chip input[type="search"],
    .chip select {
      border: 1px solid var(--surface-border);
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 14px;
      background: var(--surface);
      color: var(--text);
    }
    .chip input[type="text"]:focus,
    .chip input[type="number"]:focus,
    .chip input[type="search"]:focus,
    .chip select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: var(--focus);
      background: var(--surface-3);
    }

    /* компактный чекбокс «Только верифицированные» — без большого ободка */
    .chip input[type="checkbox"]{
      appearance: none;
      width: 16px;
      height: 16px;
      border: 1px solid var(--surface-border);
      border-radius: 4px;
      background: var(--surface);
      display: inline-grid;
      place-items: center;
      padding: 0;
      margin: 0;
    }
    .chip input[type="checkbox"]:checked{
      background: var(--primary);
      border-color: var(--primary);
    }
    .chip input[type="checkbox"]:checked::after{
      content:"";
      width:9px;height:9px;
      mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="black" d="M4.5 9.2 1.8 6.5l.9-.9 1.8 1.8 4-4 .9.9-4.9 4.9Z"/></svg>') no-repeat center/contain;
      background:#000;
      display:block;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0;
      padding: 12px;
      background: var(--surface-2);
      border-radius: 8px;
      border: 1px solid var(--surface-border);
    }
    .chip-filter {
      display: inline-flex;
      align-items: center;
      background: var(--surface-2);
      border: 1px solid var(--surface-border);
      padding: 6px 12px;
      border-radius: 16px;
      margin: 4px;
      font-size: 14px;
    }
    .chip-filter button {
      background: none;
      border: none;
      margin-left: 6px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .cards-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 12px; }
    .card-blogger {
      background: var(--surface);
      border: 1px solid var(--surface-border);
      border-radius: 12px;
      padding: 16px;
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      align-items: start;
      transition: var(--transition);
    }
    .card-blogger:hover { border-color: var(--primary); box-shadow: var(--shadow-1); }

    .card-blogger .avatar {
      width: 48px; height: 48px; border-radius: 50%;
      background: var(--surface-2);
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; color: var(--text-muted); position: relative;
    }
    .platform-badge {
      position: absolute; bottom: -4px; right: -4px;
      width: 20px; height: 20px; border-radius: 50%;
      background: var(--surface); border: 2px solid var(--surface);
      display: flex; align-items: center; justify-content: center;
      font-size: 10px; color: var(--text);
    }
    .card-blogger .name {
      font-weight: 700; font-size: 16px; color: var(--text);
      margin-bottom: 4px; display: flex; align-items: center; gap: 8px;
    }
    .verification-badge { color: var(--primary); font-size: 14px; }
    .card-blogger .meta { color: var(--text-muted); font-size: 14px; margin-bottom: 4px; line-height: 1.4; }
    .card-blogger .badge {
      display: inline-block; padding: 2px 8px; background: var(--surface-2);
      color: var(--text); border-radius: 12px; font-size: 12px; font-weight: 500;
      margin-right: 6px; margin-bottom: 4px;
    }
    .badge.highlight { background: var(--primary); color: var(--primary-ink); }
    .card-blogger .stats { display: flex; gap: 12px; margin: 8px 0; flex-wrap: wrap; }
    .stat-item { display: flex; align-items: center; gap: 4px; font-size: 13px; color: var(--text-muted); }
    .stat-item i { color: var(--primary); }
    .select-radio { display: flex; align-items: center; gap: 6px; font-size: 14px; cursor: pointer; color: var(--text); }
    .card-blogger.selected { background-color: rgba(199, 255, 26, 0.08); border-color: var(--primary); }

    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--text-muted)}

    /* Сортировка (перенесена в самый низ, как в agency.html) */
    .sort-options {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 10px 0 0 0;
      width: 100%;
    }
    .sort-label { font-weight: 600; font-size: 14px; color: var(--text); }
    .sort-buttons { display: flex; gap: 4px; flex-wrap: wrap; }
    .sort-btn {
      padding: 6px 12px; background: var(--surface-2); border: 1px solid var(--surface-border);
      border-radius: 6px; font-size: 13px; cursor: pointer; transition: var(--transition); color: var(--text);
    }
    .sort-btn:hover { background: var(--surface-3); }
    .sort-btn.active { background: var(--primary); color: var(--primary-ink); border-color: var(--primary); }

    .blogger-card-link {
      color: var(--primary); text-decoration: none; font-size: 14px;
      display: inline-flex; align-items: center; gap: 4px; margin-left: auto;
    }
    .blogger-card-link:hover { text-decoration: underline; }

    .count { font-variant-numeric: tabular-nums; font-weight: 700; color: var(--primary); }

    /* выпадающее меню Контактов как в agency.html */
    .contacts-dropdown { position: relative; display: inline-block; }
    .contacts-dropdown-content{
      display:none; position:absolute; right:0; background:var(--surface); min-width:160px;
      box-shadow:var(--shadow-1); z-index:10; border-radius:8px; padding:12px; border:1px solid var(--surface-border);
    }
    .contacts-dropdown-content a{ color:var(--text); padding:8px 12px; text-decoration:none; display:block; border-radius:4px; font-size:14px;}
    .contacts-dropdown-content a:hover{ background:var(--surface-3); }
    .contacts-dropdown:hover .contacts-dropdown-content{ display:block; }
  </style>

  <!-- Скрипты (ВАЖЕН ПОРЯДОК) -->
  <script defer src="../js/include.js?v=6"></script>
  <script defer src="../js/notify.js?v=1"></script>
  <script defer src="../js/messenger.js?v=1"></script>
  <script defer src="../js/message-templates.js?v=1"></script>
  <script defer src="../js/ai-brief.js?v=1"></script>

  <!-- Инициализация шага «Подбор» со строго той же системой фильтров, что и в agency.html -->
  <script defer>
    // Этот init вызывается роутером на шаге 1
    window.initPickStep = function(){
      // Состояние (как в agency.html)
      const appState = {
        selectedBloggers: JSON.parse(localStorage.getItem('selectedBloggers')||'[]'),
        currentSort: 'relevance',
        // Моки (1:1 с agency.html)
        mockBloggers: [
          { 
            id: 1, name: "Иван Петров", username: "tech_review", platform: "YouTube", 
            followers: 125000, avg_views: 45000, er: 4.5, price: 2500,
            blogger_gender: "male", blogger_age: "28", blogger_country: "Россия", blogger_language: "Русский",
            audience_gender: "male", audience_age: "25-34", audience_country: "Россия", audience_language: "Русский",
            growth: "growing", last_post: "2023-10-20", has_email: true, has_phone: false, has_telegram: true, has_whatsapp: false,
            verified: true, bio: "Обзоры техники и гаджетов | Tech reviewer | unboxing"
          },
          { 
            id: 2, name: "Анна Сидорова", username: "anna_beauty", platform: "Instagram", 
            followers: 87000, avg_views: 25000, er: 7.2, price: 1800,
            blogger_gender: "female", blogger_age: "22", blogger_country: "Россия", blogger_language: "Русский",
            audience_gender: "female", audience_age: "18-24", audience_country: "Россия", audience_language: "Русский",
            growth: "stable", last_post: "2023-10-22", has_email: true, has_phone: true, has_telegram: false, has_whatsapp: true,
            verified: false, bio: "💄 Косметика и уход | Beauty blogger | makeup tutorials"
          },
          { 
            id: 3, name: "Сергей Козлов", username: "game_master", platform: "YouTube", 
            followers: 356000, avg_views: 89000, er: 3.8, price: 4200,
            blogger_gender: "male", blogger_age: "25", blogger_country: "США", blogger_language: "Английский",
            audience_gender: "male", audience_age: "13-17", audience_country: "США", audience_language: "Английский",
            growth: "growing", last_post: "2023-10-15", has_email: false, has_phone: false, has_telegram: true, has_whatsapp: false,
            verified: true, bio: "Gaming channel | Live streams | Game reviews"
          },
          { 
            id: 4, name: "Мария Иванова", username: "fashion_maria", platform: "Instagram", 
            followers: 210000, avg_views: 65000, er: 8.1, price: 1900,
            blogger_gender: "female", blogger_age: "21", blogger_country: "Великобритания", blogger_language: "Английский",
            audience_gender: "female", audience_age: "18-24", audience_country: "Великобритания", audience_language: "Английский",
            growth: "growing", last_post: "2023-10-23", has_email: true, has_phone: true, has_telegram: true, has_whatsapp: true,
            verified: true, bio: "Fashion & lifestyle | Outfit ideas | London based"
          },
          { 
            id: 5, name: "Дмитрий Смирнов", username: "news_dima", platform: "YouTube", 
            followers: 45000, avg_views: 12000, er: 5.5, price: 1200,
            blogger_gender: "male", blogger_age: "40", blogger_country: "Россия", blogger_language: "Русский",
            audience_gender: "mixed", audience_age: "35-44", audience_country: "Россия", audience_language: "Русский",
            growth: "stable", last_post: "2023-10-23", has_email: true, has_phone: false, has_telegram: false, has_whatsapp: false,
            verified: false, bio: "Новости и аналитика | Политика и экономика"
          }
        ]
      };

      const $ = (sel) => document.querySelector(sel);

      setupEventListeners();
      renderBloggersList();
      updateSelectionCount();
      updateActiveChips();

      function setupEventListeners() {
        // Фильтры
        const filterIds = [
          'fPlatform', 'followersMin', 'followersMax', 'fFollowersUnit',
          'fAvgViewsMin', 'fErMin', 'fErMax', 'fGrowth', 'fLastPost',
          'fBloggerGender', 'fBloggerAge', 'fBloggerLanguage', 'fBloggerCountry',
          'fAudienceGender', 'fAudienceAge', 'fAudienceCountry', 'fAudienceLanguage',
          'fKeywords', 'fBio', 'fContactType', 'fSimilarTo'
        ];
        filterIds.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener('input', applyFilters);
          el.addEventListener('change', applyFilters);
        });

        // Чекбокс
        ['fVerifiedOnly'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('change', applyFilters);
        });

        // Кнопки управления
        document.getElementById('clearFilters')?.addEventListener('click', clearAllFilters);
        document.getElementById('selectAll')?.addEventListener('click', selectAllFiltered);
        document.getElementById('clearPicked')?.addEventListener('click', clearSelectedBloggers);
        document.getElementById('exportResults')?.addEventListener('click', exportToCSV);

        // Сортировка
        document.querySelectorAll('.sort-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            appState.currentSort = this.dataset.sort;
            applyFilters();
          });
        });
      }

      function applyFilters() {
        renderBloggersList();
        updateActiveChips();
        updateSelectionCount();
      }

      function clearAllFilters() {
        const inputs = document.querySelectorAll('#filtersForm input, #filtersForm select');
        inputs.forEach(input => {
          if (input.type === 'checkbox') input.checked = false;
          else input.value = '';
        });

        // сброс сортировки к «релевантности»
        document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
        const rel = document.querySelector('.sort-btn[data-sort="relevance"]');
        if (rel) rel.classList.add('active');
        appState.currentSort = 'relevance';

        applyFilters();
      }

      function updateActiveChips() {
        const chipsContainer = document.getElementById('activeChips');
        if (!chipsContainer) return;
        chipsContainer.innerHTML = '';

        const addChip = (text, clearFn) => {
          const chip = document.createElement('div');
          chip.className = 'chip-filter';
          chip.innerHTML = `${text} <button type="button">×</button>`;
          chip.querySelector('button').addEventListener('click', clearFn);
          chipsContainer.appendChild(chip);
        };

        const platform = $('#fPlatform')?.value;
        const growth = $('#fGrowth')?.value;
        const bloggerGender = $('#fBloggerGender')?.value;
        const contactType = $('#fContactType')?.value;
        const erMin = $('#fErMin')?.value;
        const erMax = $('#fErMax')?.value;
        const verified = $('#fVerifiedOnly')?.checked;

        if (platform) addChip(`Платформа: ${platform}`, () => { $('#fPlatform').value = ''; applyFilters(); });
        if (growth) addChip(`Рост: ${growth}`, () => { $('#fGrowth').value = ''; applyFilters(); });
        if (bloggerGender) addChip(`Пол: ${bloggerGender}`, () => { $('#fBloggerGender').value = ''; applyFilters(); });
        if (contactType) addChip(`Контакт: ${contactType}`, () => { $('#fContactType').value = ''; applyFilters(); });
        if (erMin) addChip(`ER от: ${erMin}%`, () => { $('#fErMin').value = ''; applyFilters(); });
        if (erMax) addChip(`ER до: ${erMax}%`, () => { $('#fErMax').value = ''; applyFilters(); });
        if (verified) addChip('Только верифицированные', () => { $('#fVerifiedOnly').checked = false; applyFilters(); });
      }

      function renderBloggersList() {
        const listContainer = document.getElementById('resultsList');
        if (!listContainer) return;
        listContainer.innerHTML = '';

        const filters = {
          platform: $('#fPlatform')?.value || '',
          followersMin: parseInt($('#followersMin')?.value) || 0,
          followersMax: parseInt($('#followersMax')?.value) || Infinity,
          followersUnit: $('#fFollowersUnit')?.value || 'k',
          avgViewsMin: parseInt($('#fAvgViewsMin')?.value) || 0,
          erMin: parseFloat($('#fErMin')?.value) || 0,
          erMax: parseFloat($('#fErMax')?.value) || Infinity,
          growth: $('#fGrowth')?.value || '',
          lastPost: $('#fLastPost')?.value || '',
          bloggerGender: $('#fBloggerGender')?.value || '',
          bloggerAge: $('#fBloggerAge')?.value || '',
          bloggerLanguage: $('#fBloggerLanguage')?.value || '',
          bloggerCountry: $('#fBloggerCountry')?.value || '',
          audienceGender: $('#fAudienceGender')?.value || '',
          audienceAge: $('#fAudienceAge')?.value || '',
          audienceCountry: $('#fAudienceCountry')?.value || '',
          audienceLanguage: $('#fAudienceLanguage')?.value || '',
          keywords: ($('#fKeywords')?.value || '').toLowerCase(),
          bio: ($('#fBio')?.value || '').toLowerCase(),
          contactType: $('#fContactType')?.value || '',
          verifiedOnly: $('#fVerifiedOnly')?.checked || false,
          similarTo: $('#fSimilarTo')?.value || ''
        };

        let filtered = appState.mockBloggers.filter(b => {
          if (filters.platform && b.platform !== filters.platform) return false;

          const followersValue = filters.followersUnit === 'm' ? b.followers / 1_000_000 : b.followers / 1_000;
          if (followersValue < filters.followersMin || followersValue > filters.followersMax) return false;

          if (b.avg_views < filters.avgViewsMin) return false;
          if (b.er < filters.erMin || b.er > filters.erMax) return false;

          if (filters.growth && b.growth !== filters.growth) return false;

          if (filters.bloggerGender && b.blogger_gender !== filters.bloggerGender) return false;
          if (filters.bloggerAge && b.blogger_age !== filters.bloggerAge) return false;
          if (filters.bloggerCountry && b.blogger_country !== filters.bloggerCountry) return false;
          if (filters.bloggerLanguage && b.blogger_language !== filters.bloggerLanguage) return false;

          if (filters.audienceGender && b.audience_gender !== filters.audienceGender) return false;
          if (filters.audienceAge && b.audience_age !== filters.audienceAge) return false;
          if (filters.audienceCountry && b.audience_country !== filters.audienceCountry) return false;
          if (filters.audienceLanguage && b.audience_language !== filters.audienceLanguage) return false;

          if (filters.contactType) {
            if (filters.contactType === 'email' && !b.has_email) return false;
            if (filters.contactType === 'phone' && !b.has_phone) return false;
            if (filters.contactType === 'telegram' && !b.has_telegram) return false;
            if (filters.contactType === 'whatsapp' && !b.has_whatsapp) return false;
            if (filters.contactType === 'instagram_dm' && b.platform !== 'Instagram') return false;
          }

          if (filters.verifiedOnly && !b.verified) return false;

          if (filters.keywords && !(
            b.name.toLowerCase().includes(filters.keywords) ||
            (b.bio||'').toLowerCase().includes(filters.keywords)
          )) return false;

          if (filters.bio && !(b.bio||'').toLowerCase().includes(filters.bio)) return false;

          if (filters.lastPost) {
            const days = parseInt(filters.lastPost, 10);
            const d = new Date();
            const cutoff = new Date(d.getFullYear(), d.getMonth(), d.getDate() - days);
            if (new Date(b.last_post) < cutoff) return false;
          }

          return true;
        });

        // Сортировка
        switch(appState.currentSort) {
          case 'followers': filtered.sort((a,b)=> b.followers - a.followers); break;
          case 'avg_views': filtered.sort((a,b)=> b.avg_views - a.avg_views); break;
          case 'er':        filtered.sort((a,b)=> b.er - a.er); break;
          case 'relevance':
          default:
            filtered.sort((a,b)=>(b.followers + b.avg_views + b.er*1000) - (a.followers + a.avg_views + a.er*1000));
            break;
        }

        // Счётчики (опционально присутствуют на странице)
        const rc1 = document.getElementById('resultsCount'); if (rc1) rc1.textContent = filtered.length;
        const rc2 = document.getElementById('resultsCount2'); if (rc2) rc2.textContent = filtered.length;
        const pc2 = document.getElementById('pickedCount2'); if (pc2) pc2.textContent = appState.selectedBloggers.length;

        // Рендер
        if (!filtered.length) {
          listContainer.innerHTML = '<li class="muted">Ничего не найдено. Попробуйте изменить фильтры.</li>';
          return;
        }

        filtered.forEach(b => {
          const isSelected = appState.selectedBloggers.some(x => x.id === b.id);
          const li = document.createElement('li');
          li.className = 'card-blogger' + (isSelected ? ' selected' : '');
          li.innerHTML = `
            <div class="avatar">
              ${b.name.charAt(0)}
              <div class="platform-badge">${getPlatformIcon(b.platform)}</div>
            </div>
            <div>
              <div class="name">
                ${b.name}
                ${b.verified ? '<span class="verification-badge"><i class="fas fa-check-circle"></i></span>' : ''}
                <span class="muted">@${b.username}</span>
                <a href="blogger-card.html?id=${b.id}" class="blogger-card-link">
                  <i class="fas fa-external-link-alt"></i> Карточка
                </a>
              </div>
              <div class="meta">
                <span class="badge">${b.platform}</span>
                <span class="badge">${b.blogger_country}</span>
                <span class="badge">ER: ${b.er}%</span>
                ${b.growth === 'growing' ? '<span class="badge highlight"><i class="fas fa-arrow-up"></i> Растет</span>' : ''}
              </div>
              <div class="stats">
                <div class="stat-item"><i class="fas fa-users"></i> ${formatFollowers(b.followers)}</div>
                <div class="stat-item"><i class="fas fa-eye"></i> ${formatNumber(b.avg_views)}</div>
                <div class="stat-item"><i class="fas fa-chart-line"></i> ${b.er}% ER</div>
              </div>
              <div class="meta">
                Блогер: ${b.blogger_gender === 'male' ? 'М' : 'Ж'}, ${b.blogger_age} | 
                Аудитория: ${b.audience_gender === 'male' ? 'М' : (b.audience_gender==='female'?'Ж':'Смеш.')}, ${b.audience_age}
              </div>
              <div class="meta">
                ${b.bio || ''}
              </div>
              <div class="actions">
                <label class="select-radio">
                  <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleBloggerSelection(${b.id})" />
                  В выборку
                </label>
                <div class="contacts-dropdown">
                  <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;">
                    <i class="fas fa-envelope"></i> Контакты
                  </button>
                  <div class="contacts-dropdown-content">
                    ${b.has_email ? '<a href="#"><i class="fas fa-envelope"></i> Email</a>' : ''}
                    ${b.has_phone ? '<a href="#"><i class="fas fa-phone"></i> Телефон</a>' : ''}
                    ${b.has_telegram ? '<a href="#"><i class="fab fa-telegram"></i> Telegram</a>' : ''}
                    ${b.has_whatsapp ? '<a href="#"><i class="fab fa-whatsapp"></i> WhatsApp</a>' : ''}
                    ${b.platform === 'Instagram' ? '<a href="#"><i class="fab fa-instagram"></i> Instagram DM</a>' : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
          listContainer.appendChild(li);
        });
      }

      function getPlatformIcon(p) { return ({'YouTube':'▶️','Instagram':'📷','TikTok':'🎵'})[p] || '🌐'; }
      function formatFollowers(n){ if(n>=1_000_000) return (n/1_000_000).toFixed(1)+'M'; if(n>=1_000) return (n/1_000).toFixed(1)+'K'; return n; }
      function formatNumber(n){ if(n>=1_000_000) return (n/1_000_000).toFixed(1)+'M'; if(n>=1_000) return (n/1_000).toFixed(1)+'K'; return n; }

      // Глобально, как в agency.html (используется в onchange)
      window.toggleBloggerSelection = function(id){
        const b = appState.mockBloggers.find(x=>x.id===id);
        if (!b) return;
        const i = appState.selectedBloggers.findIndex(x=>x.id===id);
        if (i===-1) appState.selectedBloggers.push(b);
        else appState.selectedBloggers.splice(i,1);
        localStorage.setItem('selectedBloggers', JSON.stringify(appState.selectedBloggers));
        updateSelectionCount();
        renderBloggersList(); // обновить подсветку/чекбоксы
      };

      function updateSelectionCount(){
        const picked = appState.selectedBloggers.length;
        const p1 = document.getElementById('pickedCount'); if (p1) p1.textContent = picked;
        const p2 = document.getElementById('pickedCount2'); if (p2) p2.textContent = picked;
      }

      function selectAllFiltered(){
        const listContainer = document.getElementById('resultsList');
        const ids = Array.from(listContainer.querySelectorAll('.card-blogger input[type="checkbox"]'))
          .map(cb => parseInt(cb.getAttribute('onchange').match(/\d+/)[0],10))
          .filter(Boolean);
        ids.forEach(id=>{
          if (!appState.selectedBloggers.some(x=>x.id===id)) {
            const b = appState.mockBloggers.find(x=>x.id===id);
            if (b) appState.selectedBloggers.push(b);
          }
        });
        localStorage.setItem('selectedBloggers', JSON.stringify(appState.selectedBloggers));
        updateSelectionCount();
        renderBloggersList();
      }

      function clearSelectedBloggers(){
        appState.selectedBloggers = [];
        localStorage.setItem('selectedBloggers', JSON.stringify(appState.selectedBloggers));
        updateSelectionCount();
        renderBloggersList();
      }

      function exportToCSV(){
        const headers = ['Имя','Username','Платформа','Подписчики','Просмотры','ER','Страна'];
        const data = appState.selectedBloggers.length ? appState.selectedBloggers : appState.mockBloggers;
        const csv = [
          headers.join(','),
          ...data.map(b=>[
            `"${b.name}"`,
            `"${b.username}"`,
            b.platform,
            b.followers,
            b.avg_views,
            b.er,
            b.blogger_country
          ].join(','))
        ].join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'bloggers_export.csv';
        a.style.display='none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    };
  </script>

  <script defer src="../js/deal-router.js?v=7"></script>
</head>
<body>
  <div data-include="/components/header.html"></div>

  <div class="deal-wrap container">
    <!-- Сайдбар-воронка -->
    <aside class="deal-sidebar" aria-label="Этапы сделки">
      <nav id="dealNav" class="steps-vertical">
        <a href="#/1-pick"     data-step="1">1. Подбор</a>
        <a href="#/2-brief"    data-step="2">2. Бриф</a>
        <a href="#/3-email"    data-step="3">3. Привязка почты</a>
        <a href="#/4-outreach" data-step="4">4. Рассылка</a>
        <a href="#/5-contract" data-step="5">5. Договор</a>
        <a href="#/6-payment"  data-step="6">6. Оплата</a>
        <a href="#/7-shoot"    data-step="7">7. Съёмка</a>
        <a href="#/8-approval" data-step="8">8. Одобрение</a>
        <a href="#/9-payout"   data-step="9">9. Выплата</a>
      </nav>
    </aside>

    <!-- Контент -->
    <main class="deal-main">
      <!-- Верхние табы -->
      <div id="dealTabs" class="deal-tabs">
        <button data-step="1">Подбор</button>
        <button data-step="2">Бриф</button>
        <button data-step="3">Почта</button>
        <button data-step="4">Рассылка</button>
        <button data-step="5">Договор</button>
        <button data-step="6">Оплата</button>
        <button data-step="7">Съёмка</button>
        <button data-step="8">Одобрение</button>
        <button data-step="9">Выплата</button>
      </div>

      <!-- Хост для контента шагов -->
      <section id="stepHost" class="card" style="padding:16px"></section>

      <!-- Нижняя навигация -->
      <footer class="deal-footer row" style="justify-content:space-between">
        <button id="prevBtn" class="btn btn-secondary" type="button">Назад</button>
        <div class="muted">Этап <span id="stepNow">1</span> из 9</div>
        <button id="nextBtn" class="btn" type="button">Далее</button>
      </footer>
    </main>
  </div>

  <div data-include="/components/footer.html"></div>

  <!-- ================== ШАБЛОНЫ ШАГОВ ================== -->

  <!-- Шаг 1: Подбор — фильтры и сортировка 1:1 с agency.html (сортировка в самом низу) -->
  <template id="tpl-1-pick">
    <h2>Подбор блогеров</h2>

    <!-- ФИЛЬТР-БАР -->
    <form id="filtersForm" class="filterbar" onsubmit="return false">
      <!-- Группа 1: Платформа и статистика -->
      <div class="filter-group">
        <h3 class="filter-group-title"><i class="fas fa-globe"></i> Платформа и статистика</h3>

        <div class="chip">
          <label>Платформа</label>
          <select id="fPlatform">
            <option value="">Все платформы</option>
            <option>Instagram</option>
            <option>YouTube</option>
            <option>TikTok</option>
          </select>
        </div>

        <div class="chip">
          <label>Подписчики</label>
          <input id="followersMin" type="number" min="0" step="1" placeholder="от" style="width:80px" />
          <span class="muted">—</span>
          <input id="followersMax" type="number" min="0" step="1" placeholder="до" style="width:80px" />
          <select id="fFollowersUnit" style="width: 60px;">
            <option value="k">тыс.</option>
            <option value="m">млн</option>
          </select>
        </div>

        <div class="chip">
          <label>Ср. просмотры</label>
          <input id="fAvgViewsMin" type="number" placeholder="от" min="0" step="1000" style="width:90px" />
        </div>

        <div class="chip">
          <label>ER, %</label>
          <input id="fErMin" type="number" placeholder="от" min="0" max="100" step="0.1" style="width:80px" />
          <span class="muted">—</span>
          <input id="fErMax" type="number" placeholder="до" min="0" max="100" step="0.1" style="width:80px" />
        </div>

        <div class="chip">
          <label>Рост подписчиков</label>
          <select id="fGrowth">
            <option value="">Любой</option>
            <option value="growing">Растущий</option>
            <option value="stable">Стабильный</option>
            <option value="declining">Падающий</option>
          </select>
        </div>

        <div class="chip">
          <label>Последний пост</label>
          <select id="fLastPost">
            <option value="">Не важно</option>
            <option value="1">За сутки</option>
            <option value="7">За неделю</option>
            <option value="30">За месяц</option>
          </select>
        </div>
      </div>

      <!-- Группа 2: Блогер -->
      <div class="filter-group">
        <h3 class="filter-group-title"><i class="fas fa-user"></i> Блогер</h3>

        <div class="chip">
          <label>Пол блогера</label>
          <select id="fBloggerGender">
            <option value="">Любой</option>
            <option value="male">Мужской</option>
            <option value="female">Женский</option>
          </select>
        </div>

        <div class="chip">
          <label>Возраст блогера</label>
          <select id="fBloggerAge">
            <option value="">Любой</option>
            <option value="13-17">13-17</option>
            <option value="18-24">18-24</option>
            <option value="25-34">25-34</option>
            <option value="35-44">35-44</option>
            <option value="45+">45+</option>
          </select>
        </div>

        <div class="chip">
          <label>Язык блогера</label>
          <select id="fBloggerLanguage">
            <option value="">Любой</option>
            <option>Русский</option>
            <option>Английский</option>
            <option>Испанский</option>
          </select>
        </div>

        <div class="chip">
          <label>Страна блогера</label>
          <select id="fBloggerCountry">
            <option value="">Любая</option>
            <option>Россия</option>
            <option>США</option>
            <option>Великобритания</option>
            <option>Германия</option>
            <option>Франция</option>
            <option>Испания</option>
            <option>Турция</option>
            <option>ОАЭ</option>
          </select>
        </div>
      </div>

      <!-- Группа 3: Аудитория -->
      <div class="filter-group">
        <h3 class="filter-group-title"><i class="fas fa-users"></i> Аудитория</h3>

        <div class="chip">
          <label>Пол аудитории</label>
          <select id="fAudienceGender">
            <option value="">Любой</option>
            <option value="male">Мужской</option>
            <option value="female">Женский</option>
            <option value="mixed">Смешанный</option>
          </select>
        </div>

        <div class="chip">
          <label>Возраст аудитории</label>
          <select id="fAudienceAge">
            <option value="">Любой</option>
            <option value="13-17">13-17</option>
            <option value="18-24">18-24</option>
            <option value="25-34">25-34</option>
            <option value="35-44">35-44</option>
            <option value="45+">45+</option>
          </select>
        </div>

        <div class="chip">
          <label>Страна аудитории</label>
          <select id="fAudienceCountry">
            <option value="">Любая</option>
            <option>Россия</option>
            <option>США</option>
            <option>Великобритания</option>
            <option>Германия</option>
          </select>
        </div>

        <div class="chip">
          <label>Язык аудитории</label>
          <select id="fAudienceLanguage">
            <option value="">Любой</option>
            <option>Русский</option>
            <option>Английский</option>
          </select>
        </div>
      </div>

      <!-- Группа 4: Контент и контакты -->
      <div class="filter-group">
        <h3 class="filter-group-title"><i class="fas fa-hashtag"></i> Контент и контакты</h3>

        <div class="chip">
          <label>Поиск по ключевым словам</label>
          <input id="fKeywords" type="search" placeholder="темы, ключевые слова..." style="width:180px" />
        </div>

        <div class="chip">
          <label>Поиск по bio</label>
          <input id="fBio" type="search" placeholder="слова из описания..." style="width:150px" />
        </div>

        <div class="chip">
          <label>Есть контакт</label>
          <select id="fContactType">
            <option value="">Любой контакт</option>
            <option value="email">Email</option>
            <option value="phone">Телефон</option>
            <option value="telegram">Telegram</option>
            <option value="whatsapp">WhatsApp</option>
            <option value="instagram_dm">Instagram DM</option>
          </select>
        </div>

        <div class="chip" style="gap:10px;">
          <label>
            <input type="checkbox" id="fVerifiedOnly" />
            <span>Только верифицированные</span>
          </label>
        </div>
      </div>

      <!-- Группа 5: Похожие блогеры -->
      <div class="filter-group">
        <h3 class="filter-group-title"><i class="fas fa-compress-alt"></i> Похожие блогеры</h3>

        <div class="chip">
          <label>Похожие на</label>
          <select id="fSimilarTo">
            <option value="">Не выбрано</option>
            <option value="influencer1">@popular_blogger</option>
            <option value="influencer2">@top_creator</option>
            <option value="influencer3">@famous_influencer</option>
          </select>
        </div>
      </div>

      <!-- Сортировка — строго под «Похожие блогеры», как в agency.html -->
      <div class="sort-options">
        <span class="sort-label">Сортировка:</span>
        <div class="sort-buttons">
          <button class="sort-btn" data-sort="followers">Подписчики</button>
          <button class="sort-btn" data-sort="avg_views">Просмотры</button>
          <button class="sort-btn" data-sort="er">ER</button>
          <button class="sort-btn active" data-sort="relevance">Релевантность</button>
        </div>

        <button id="clearFilters" class="btn btn-secondary" type="button" style="margin-left:auto">Очистить всё</button>
      </div>
    </form>

    <!-- Активные фильтры -->
    <div id="activeChips" class="chips"></div>

    <!-- Управление результатами -->
    <div class="row" style="justify-content:space-between;margin:20px 0;align-items:center">
      <div class="muted">Найдено: <span id="resultsCount2">0</span> · Выбрано: <span id="pickedCount2">0</span></div>
      <div class="row">
        <button id="selectAll" class="btn btn-secondary" type="button">Выбрать все</button>
        <button id="clearPicked" class="btn btn-secondary" type="button">Сбросить выбор</button>
        <button id="exportResults" class="btn" type="button"><i class="fas fa-download"></i> Экспорт</button>
      </div>
    </div>

    <!-- Результаты -->
    <ul id="resultsList" class="cards-list"></ul>
  </template>

  <!-- Шаг 2: Бриф с AI-модулем -->
  <template id="tpl-2-brief">
    <h2>Бриф</h2>

    <form id="briefForm" class="grid">
      <div class="field" style="grid-column:1/-1">
        <label>Цель кампании *</label>
        <textarea id="briefGoal" rows="4" placeholder="Опишите цели, целевую аудиторию, ключевые сообщения..." required></textarea>
      </div>

      <div class="field">
        <label>Бюджет (₽) *</label>
        <input id="briefBudget" type="number" min="1" placeholder="10000" required />
      </div>

      <div class="field">
        <label>Дедлайн *</label>
        <input id="briefDeadline" type="date" required />
      </div>

      <div class="field">
        <label>Целевая аудитория</label>
        <input id="briefAudience" type="text" placeholder="Возраст, интересы, гео" />
      </div>

      <div class="field">
        <label>Продукт/услуга</label>
        <input id="briefProduct" type="text" placeholder="Что продвигаем" />
      </div>

      <div class="field">
        <label>KPI/метрики</label>
        <input id="briefKPI" type="text" placeholder="CPA, ROAS, конверсии" />
      </div>

      <div class="field">
        <label>Тон коммуникации</label>
        <input id="briefTone" type="text" placeholder="Формальный, дружеский, экспертный" />
      </div>

      <div class="field">
        <label>Платформы</label>
        <input id="briefPlatforms" type="text" placeholder="Instagram, YouTube, TikTok" />
      </div>

      <div style="grid-column: 1/-1; display: flex; gap: 12px; align-items: center; margin-top: 16px;">
        <button type="submit" class="btn btn-primary">Сохранить бриф</button>
        <span id="briefSaved" class="muted"></span>
        
        <div style="margin-left: auto; display: flex; gap: 8px; align-items: center;">
          <span class="muted">AI-помощник:</span>
          <button type="button" id="aiAnalyzeBtn" class="btn btn-secondary">Анализ брифа</button>
          <button type="button" id="aiApplyBtn" class="btn btn-secondary" disabled>Применить идеи</button>
        </div>
      </div>
    </form>

    <div id="aiBriefPanel" class="ai-panel">
      <div class="muted">Нажмите «Анализ брифа» для получения рекомендаций</div>
    </div>
  </template>

  <!-- Шаг 3: Привязка почты -->
  <template id="tpl-3-email">
    <h2>Привязка почты</h2>
    <div class="row">
      <input id="emailAccount" type="email" placeholder="[email protected]" style="max-width:320px" />
      <button id="linkEmailBtn" class="btn">Привязать</button>
      <span id="emailStatus" class="muted"></span>
    </div>
  </template>

  <!-- Шаг 4: Рассылка -->
  <template id="tpl-4-outreach">
    <h2>Рассылка</h2>
    <p class="muted">Выбранные на шаге 1 блогеры будут предложены получателями.</p>
    <div class="row">
      <button id="sendOutreachBtn" class="btn">Отправить письма</button>
      <span id="outreachStatus" class="muted"></span>
    </div>
    <h3 style="margin-top:16px">Кто ответил?</h3>
    <ul id="outreachList" class="list"></ul>
    <button id="markRespondBtn" class="btn btn-secondary">Отметить ответы</button>
  </template>

  <!-- Шаг 5: Договор -->
  <template id="tpl-5-contract">
    <h2>Договор</h2>
    <div class="row">
      <button id="signContractBtn" class="btn">Подписать</button>
      <span id="contractStatus" class="muted"></span>
    </div>
  </template>

  <!-- Шаг 6: Оплата -->
  <template id="tpl-6-payment">
    <h2>Оплата</h2>
    <div class="row">
      <button id="reserveFundsBtn" class="btn">Зарезервировать средства</button>
      <span id="paymentStatus" class="muted"></span>
    </div>
  </template>

  <!-- Шаг 7: Съёмка черновика -->
  <template id="tpl-7-shoot">
    <h2>Съёмка черновика</h2>
    <div class="row">
      <button id="uploadBtn" class="btn">Загрузить видео</button>
      <input id="uploadInput" type="file" accept="video/*" hidden />
      <span id="shootStatus" class="muted"></span>
    </div>
  </template>

  <!-- Шаг 8: Одобрение рекламы -->
  <template id="tpl-8-approval">
    <h2>Одобрение</h2>
    <div class="field">
      <label>Ссылка на ролик</label>
      <input id="approvalLink" type="url" placeholder="https://"/>
    </div>
    <div class="field">
      <label>Комментарий</label>
      <textarea id="approvalComment" rows="2" placeholder="Необязательно"></textarea>
    </div>
    <div class="row">
      <button id="approveBtn" class="btn">Принять</button>
      <button id="requestFixBtn" class="btn btn-secondary">Запросить правки</button>
      <span id="approvalStatus" class="muted"></span>
    </div>
  </template>

  <!-- Шаг 9: Выплата блогеру -->
  <template id="tpl-9-payout">
    <h2>Выплата блогеру</h2>
    <div id="payoutInfo" class="muted">Будет проведена автоматически после «Принять».</div>
  </template>
</body>
</html>
